---
title: "PH125.9X Capstone project - Predicting the results of English Premiership Soccer Matches"
author: "Mike Woodwward"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output: 
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
    fig_caption: true
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if(!require(tidyverse)) install.packages("tidyverse", 
                                         repos = "http://cran.us.r-project.org")
if(!require(gridExtra)) install.packages("gridExtra", 
                                         repos = "http://cran.us.r-project.org")
if(!require(kableExtra)) install.packages("kableExtra", 
                                          repos = "http://cran.us.r-project.org")
library(tidyverse)
library(gridExtra)
library(kableExtra)
```

```{r, echo=FALSE, warning=FALSE}
# Load saved data
load(file=file.path("analysis", "analysis.rda"))
load(file=file.path("model", "model.rda"))
```

# Abstract

# Introduction

## Project goals

The aim of this project was to predict English Premier League (EPL) soccer match results with an accuracy better than using the mean results alone. The prediction targets in this project were home team goals and away team goals.

## EPL background and modeling features

Other authors have extensively described the origins and operation of the EPL (see for example [Robinson]), so I won't  repeat them here. I will however describe some features relevant for modeling.

The league was founded by a group of clubs who wanted a higher revenue share of TV rights money and wanted larger TV deals [Butler]. This commercial focus has continued over the last twenty-five years, with the league becoming one of the most commercially successful sports organizations in the world [Robinson]. A key part of the league's success has been its ability to attract overseas talent, in fact, the EPL is know for the very high number of foreign players. This suggests two areas for investigation:

* Do financially larger clubs score more?

* Does having a higher number of foreign-born players lead to more goals?

In common with nearly all soccer leagues worldwide, the EPL operates as the top-tier league, with a system of promotion and relegation from the league below it (now called the Champions League). Each year, several clubs are promoted and several relegated, with the rules for promotion and relegation changing over time (e.g at the 1994-1995 season, the league dropped from 22 teams to 20 via relegation). Finishing top or bottom of the league has substantial financial and reputational implications. The team that finishes top of the league are the league champions, and the top teams qualify for European competition. European competition is very lucrative, both from match attendance and from TV rights. The bottom teams may be relegated, which means a very large drop in revenue and may cause good players to leave the club. Therefore, at the end of the season, teams near the top or bottom of the league may have stronger motivations to win. This suggests another modeling feature:

* Do teams play differently as the season progresses? Are there more wins and goals as the season progresses?

Home field advantage has been extensively discussed in the literature (e.g. [Pollard], [Leard], [Thomas]). In the EPL, teams play each other twice, once at home and once away (giving 380 games for a league of 20 teams). If there were no home team advantage, we would expect the number of home wins to be about the same as the number of away wins.

* Is there evidence of a home team advantage?

On-field fair-play has been an important issue for the EPL, and for English soccer as a whole. Players receive a yellow card as a warning, with a red card for dangerous play or serious rule-breaking. A player who received a red card, or two yellow cards in the same match, is sent off (can't play in the rest of the match) and can't be substituted. His team has to play with one less player, a substantial disadvantage. However, yellow and red cards might also be associated with the kind of risk-taking that wins matches.

* Do the number of red cards and yellow cards affect a team's goal scoring ability?

## Prior work

Mathematicians have studied gambling for hundreds of years; in fact, the whole discipline of probability theory was largely created to understand gambling [Epstein]. Unlike other areas of math, those who are successful at analyzing gambling may chose not to publish, instead becoming wealthy themselves [Mezrich, Meloche]! Despite the the disincentive to publish, researchers have released a large number of studies analyzing soccer matches.

* Home field advantage has been extensively studied (e.g. [Leard], [Pollard], [Thomas], [Vergina]) and has been found to exist in many sports, including the EPL [Allen].

* Dawson *et al* [Dawson] studied consistency of red and yellow cards. They found that referees penalized away teams more (which may contribute to the home team effect). Oberstone [Oberstone] found a weak link between yellow cards and team performance.

* Several researchers ([Plumley], [Barros]) have examined the link between financial performance and on-field performance, but financial performance has been measured using company financial reports (e.g. incomes statements), not the transfer value of the team.

* Surprisingly little has been written about seasonal effects. Allen *et al* [Allen] found a relationship betwen the size of the home advantage effect and final league position.

## Data sources and data definitions

EPL data is widely available on the internet, but much of it is in summary form. I used two detailed sources.

**Match results**. These came from [Football-data](https://www.football-data.co.uk). The data goes back to the foundation of the EPL in the 1992/1993 season, but the data before the 2000-2001 has fewer fields, for example, the red card data only appears from 2000-2001 onwards. This data is available per season in CSV files.  

**Market value, team size, and foreign players**. This data comes from [TransferMarkt](https://www.transfermarkt.com/) and is only fully available for the 2011-2012 season and onwards.  

* The market value for a club is the transfer value of its players, for example, if a team buys a new player for £200mn, then the value of the team goes up by £200mn. Transfermarkt update this value twice a month.

* A soccer team fields 11 players in a match, but substitutions are allowed and of course players get sick or may have to miss games due to births, deaths, marriages, etc. A team will typically have a roster of 20+ players they will choose between (the team size). Transfermarkt update this value twice a month.

* 'Foreign' players here means any player born outside of England. There are some complexities with this definition (for example, an immigrant child may have grown up in England and be English in all but birth, but this definition still counts them as 'Foreign'), but it's the best available definition. TransferMarkt update this data at the start of the season.

I scrapped the TransferMarkt data from its website using rvest. 

## Data preparation

English soccer teams are often known by several names, for example, Manchester United is also known as:

* Man Utd

* Man United

* Manchester United

* Manchester United FC

* MUFC

and various derivates and combinations. To join data from different sources, I needed a consistent naming convention. I used the EPL codes for teams and mapped name variations to the code, for example, I mapped 'Man United' and 'Manchester United' to the code MUN.

TransferMarkt calculates team values and team sizes twice a month, but games are held many times a month on different days. To map team value (and team size) to matches, I used r's fill function to interpolate team values for the day of the match. 

Using a simple join on team and season, I use the foreign player count at the start of the season for all matches in the season. If a team purchases or sells a foreign player during the season, the foreign player count will no longer be accurate. However, EPL teams are known for having a very high number of foreign players, in which case, adding or removing a small number of foreign players might have a small effect.

Season week turns out to be an important modeling parameter, but it required some effort to calculate. It's easy to calculate a week of year, but the EPL season typically starts in August and runs to May of the next year, meaning the week number will rollover to 1 in the first week of the new year. However, we can work out an offset and apply it to all match dates and then take the week number, which will yield season week number in a consistent way.

I stored the data used for analysis and modeling in a data frame called match_results. In the Appendix, I explain the meaning of the field names in this data frame.

## Running the software

Instructions for how to run the software are in the Appendix.

# Data analysis and feature selection

## Home field advantage

If there were no home field advantage, we would expect the number of home and away wins to be roughly equal. More formally, we might expect:

\[\frac{count\ of\ home\ wins}{count\ of\ home\ wins + count\ of\ away\ wins} \approx 0.5\]

and the test for equivalence would be a z-test or a t-test as appropriate.

Here are the results for the EPL. The error bars are the 95% confidence interval.

```{r, echo=FALSE, warning=FALSE, fig.cap="Fraction of home wins vs. Season", fig.height=3.5, fig.width=9}
print(plt_home_wins)
```

Even without running a formal statistical test, it's obvious there's a very strong home field advantage and therefore this is a feature I need to include in my model. The magnitude of this result is consistent with the literature [Allen].

Interestingly, the 2020-2021 results suggest a mechanism for home field advantage. Due to COVID-19, this season is running entirely without spectators; teams are playing in empty stadiums. Notably, for 2020-2021, the fraction of home wins, `r sprintf("%.3f", home_wins_proportion_2020_2021)`, is close to 0.5 (the larger error bars are because the season is only part way through at the time of analysis). It seems like that the home field advantage may be due to home spectators.

The home team effect is also apparent if we look at goal difference. Goal difference is the difference between the number of goals scored by the home team and the away team. In Figure 2, I've plotted the mean goal difference (over all games in the season) against the season. Clearly, home team advantage is worth about 0.35 goals, except for 2020-2021 (more evidence of a COVID effect).

```{r, echo=FALSE, warning=FALSE, fig.cap="Mean(Home goals - away goals) vs. Season", fig.height=3.5, fig.width=9}
print(plt_home_goal_difference)
```

## Team value advantage

Is having a more valuable team than your opponents an advantage? As a reminder, team value in this project is the notional transfer value of the team as reported by TransferMarkt.

For each match in each season, I calculated a value difference and a goal difference. Figure 3 shows the result, each point is a match (with an alpha of 0.3 to show where matches overlap), the (red) straight line is a linear fit, with the light red zone a 95% confidence interval. The chart clearly shows the aggregate effect of a value difference between teams, with a £700mn difference worth about 2 goals for the more valuable team.

```{r, echo=FALSE, warning=FALSE, fig.cap="Goal difference vs. value difference", fig.height=3.5, fig.width=9}
print(plt_team_value)
```

## Foreign players

The EPL is famous for having large numbers of foreign players, [TransferMarkt](https://www.transfermarkt.co.uk/premier-league/marktwerteverein/wettbewerb/GB1) notes that about *63%* of players in the league are foreign born. The obvious question is, does having foreign born players give a team an advantage?

For each match in each season, I plotted goal difference vs. the difference in foreign player count. Figure 4 shows there's a small effect. 

```{r, echo=FALSE, warning=FALSE, fig.cap="Goal difference vs. foreign player difference", fig.height=3.5, fig.width=9}
print(plt_foreign)
```

## Mean age

It may be true that younger players have more energy, older players have more experience, but what about at the team level? Does the mean age of the team make a difference? For each match, I plotted the goal difference vs the difference in mean age for the teams (Figure 5). There is an effect, worth maybe a goal for a 5 year difference, to put it simply, older teams appear to be at a disadvantage. 

```{r, echo=FALSE, warning=FALSE, fig.cap="Goal difference vs. difference in mean age", fig.height=3.5, fig.width=9}
print(plt_age)
```

## Squad size

There are league rules on the maximum size of squads, which is currently 25 players. For the 2020-2021 season, every team has a squad of 25 players, but that hasn't always been the case and there was much more variability in the past. Is squad size a useful feature? I plotted goal difference against squad size difference for every match in Figure 6.

```{r, echo=FALSE, warning=FALSE, fig.cap="Goal difference vs. difference in squad size", fig.height=3.5, fig.width=9}
print(plt_size)
```

If there is an effect, it's very small. As squad sizes are now limited to 25 and every team has a squad of 25, I've excluded squad size as a modeling feature.

## Season effects

As I explained earlier, at the end of the season, some teams may have additional incentives to win. If we look at seasons on a weekly basis, we should see the proportion of matches that ended in a draw go down as the season progresses. 

(Season week effects required more data preparation than usual. It's easy to calculate a week of year, but the season typically starts in August and runs to May of the next year, meaning the week number will rollover to 1 in the first week of the new year. However, we can work out an offset and apply it to all match dates and then take the week number - this will yield season week number in a consistent way.)

For each season week, I calculated the proportion of matches that were draws and plotted them in Figure 7. There's a clear trend downward as the season progresses. 

```{r, echo=FALSE, warning=FALSE, fig.cap="Draw proportion vs. week in season", fig.height=3.5, fig.width=9}
print(plt_season)
```

This effect is also apparent in the mean absolute goal difference as the season progresses, meaning games are won by a larger goal margin (Figure 8). Interestingly, the number of goals scored per match doesn't change very much during the season, suggesting it's the split of goals between the team that changes.

```{r, echo=FALSE, warning=FALSE, fig.cap="Mean absolute goal difference  vs. week in season", fig.height=3.5, fig.width=9}
print(plt_season_magd)
```

## Discipline

Are the number of red cards or yellow cards a team has a useful predictor? As the season progresses, teams will accumulate more red cards and yellow cards, so to remove season time effects, I took the mean number of red cards and yellow cards prior to the game, so for game $i$ between teams A and B, my red card difference was:

\[ \left( \frac{1}{i-1}\sum_{g=1}^{i-1} red\ cards \right)_{Team A}  - \left( \frac{1}{i-1}\sum_{g=1}^{i-1} red\ cards \right)_{Team B}\]

where team A was the team with the higher number of red cards.

The plot below shows very little effect for yellow cards. Even counting the total number of yellow cards instead of taking an average shows very little effect. I will exclude yellow card from my modeling.

```{r, echo=FALSE, warning=FALSE, fig.cap="Goal difference  vs. yellow card difference", fig.height=3.5, fig.width=9}
plt_yellow
```

The red card effect is small, and oddly, it's a positive effect.

```{r, echo=FALSE, warning=FALSE, fig.cap="Goal difference  vs. red card difference", fig.height=3.5, fig.width=9}
plt_red
```

## Points

Like most soccer leagues, the EPL awards 3 points for win, 1 for a draw, and none for a loss. Each team will have a number of points before a match. Points encode a team's track record, the more successful a team is, the more points it will have. Does the difference in points before a match predict goal difference? To remove season effects, I calculated the mean number of points (per match) each team has prior to their match.

```{r, echo=FALSE, warning=FALSE, fig.cap="Goal difference  vs. mean point difference", fig.height=3.5, fig.width=9}
print(plt_points)
```

There's a strong effect. To put it simply, teams with a stronger points record tend to score more goals against teams with a weaker points record.

## Feature selection

My analysis has shown the following features are worth including in machine learning:

* Home team

* Team value difference

* Foreign player count difference between teams

* Mean age difference between teams

* Week in season

* Mean points difference

* Mean red card difference

But the following features are not worth including:

* Team size

* Yellow card count.

Because COVID-19 is such a disruptive event, I will exclude the 2020-2021 season from my modeling work.

# Modeling

A soccer match result is a two-dimensional variable, it consists of a home team score and an away team score. This is known as multi-dimensional regression [Borchani] and the techniques involved go well beyond the scope of [PH125](https://www.edx.org/professional-certificate/harvardx-data-science). To transform this into a one-dimensional problem, there are at least three approaches:

* Goal difference prediction. Predict goal difference rather than score. The easiest way to do this is to calculate $home\ goals - away\ goals$, however, this is approach is less satisfying from a prediction viewpoint.

* One model, split games. In this approach, every game is split in two, with a 'Home' version and an 'Away' version. A prediction is made for the Home version and the Away version, with a 'Home' variable indicating which version. This approach has two upsides, it produces a game score, and also allows the magnitude of the home effect to be studied.

* Home and Away models. Here, we have two models, one a home goals model and one an away goals model. This will predict scores, which is more satisfying, but it hides the home effect.

I decided to use two models:

* One model, split games

* Home and Away models 

Goals are are integer numbers $\geq 0$, however, there is value in real number model predictions. For example, if 2 away goals were scored in a match, and two models predicted 1.5 and 1.9, we would consider the 1.9 model to be better. My success criteria is minimizing a loss function, and similarly to the MovieLens project, I decided on RMSE as my loss function:
\[RMSE = \sqrt{\frac{1}{N}\sum_{u,i}{(\hat y_{u,i} - y_{u,i})^2}}\] 
where: 

* $N$ is the number of matches, 

* $\hat y_{i}$ is the predicted number of goals for the ith game

* $y_{i}$ is the actual number of goals for the $i$th game

Not all features are available for all seasons. For this reason, I selected seasons 2011-2012 and onwards for modeling. As I showed in feature selection, the 2020-2021 season shows a strong COVID effect, so I'll exclude this season from my modeling and prediction work.

## Holdout, test, and training data sets

I split the matches data set 90%-10%, with 10% of matches as a hold out used for *final evaluation only*. The 90% I split again, 90%-10% as a train and test set.

## One model, split games

### Baseline

My baseline model is a mean home goals and mean away goals model, I calculated the means using the training set and evaluated the result with the  test data set.   

* Away RMSE: `r RMSE_baseline_away`

* Home RMSE: `r RMSE_baseline_home`

Given that soccer is low scoring game, these RMSE scores are not good.

## Generalized linear models

## Glmnet

## Random forest



# Discussion and conclusion


# References

[Allen] Mark S. Allen, Marc V. Jones, The home advantage over the first 20 seasons of the English Premier League: Effects of shirt colour, team ability and time trends, International Journal of Sport and Exercise Psychology. Vol. 12, No. 1, 10–18

[Barros] Barros CP, Leach S. Analyzing the Performance of the English F.A. Premier League With an Econometric Frontier Model. Journal of Sports Economics. 2006;7(4):391-407

[Borchani] Borchani, H., Varando, G., Bielza, C. and Larrañaga, P. (2015), A survey on multi‐output regression. WIREs Data Mining Knowl Discov, 5: 216-233, 

[Butler] Robert Butler, Patrick Massey, Has Competition in the Market for
Subscription Sports Broadcasting Benefited Consumers? The Case of the
English Premier League, Journal of Sports Economics 

[Dawson] Peter Dawson, Stephen Dobson, John Goddard, John Wilson, Are football referees really biased and inconsistent?
Evidence on the incidence of disciplinary sanction in the English Premier League, Journal of the Royal Statistical Society: Series A (Statistics in Society), 170: 231-250

[Epstein] Richard A. Epstein, The Theory of Gambling and Statistical Logic, Academic Press, 2nd Edition, 2009

[Leard] Leard B, Doyle JM. The Effect of Home Advantage, Momentum, and Fighting on Winning in the National Hockey League. Journal of Sports Economics. 2011;12(5):538-560.

[Mezrich] Ben Mezrich, Bringing down the house, Atria Books, 2002

[Meloche] Renee Meloche, The High-Tech Gambler: The True Story of Keith Taft & His Astonishing Machines, 2012 

[Oberstone] Joel Oberstone, Differentiating the Top English Premier League Football Clubs from the Rest of the Pack: Identifying the Keys to Success, Journal of Quantitative Analysis in Sports, Volume 5, Issue 3, 2009, Article 10

[Plumley] Daniel James Plumley, Robert Wilson and Simon Shibli, A holistic performance assessment of English Premier League football clubs 1992-2013. Journal of Applied Sport Management, 9 (1)

[Pollard] Richard Pollard and Gregory Pollard, Home advantage in soccer: a review of its existence and causes, International Journal of Soccer and Science Journal Vol. 3 No 1 2005, pp28-44

[Robinson] Joshua Robinson, Jonathan Clegg, The Club: How the English Premier League Became the Wildest, Richest, Most Disruptive Force in Sports, Mariner Books, 2019

[Thomas] Thomas S, Reeves C, Bell A. Home Advantage in the Six Nations Rugby Union Tournament. Perceptual and Motor Skills. 2008;106(1):113-116

[Vergina] Roger C.Vergina, John J.Sosika, No place like home: an examination of the home field advantage in gambling strategies in NFL football, Journal of Economics and Business Volume 51, Issue 1, January–February 1999, Pages 21-31

# Appendix

**Standard error of a proportion**

If the proportion is $\frac{m}{n}$ where $n$ is the number of samples, then:

\[\hat p = \frac{m}{n}\] is the mean

\[SE = \sqrt{\frac{\hat p (1 - \hat p)}{n}}\] and is the standard error.

The 95% confidence interval is:

\[\hat p \pm 1.96*SE\]

**Fields used in data analysis**

Analysis and modeling is done with the data frame match_results. Here are the fields in the match_results data frame.

```{r, echo=FALSE, warning=FALSE}
# Read in the 
base_fields <- read.csv(file.path("data_download", 
                                 "miscellaneous", 
                                 "BaseFieldsExplanation.csv"))
base_table <- base_fields %>%   
  knitr::kable() %>% 
  kable_styling() %>% 
  row_spec(0,bold=TRUE) %>%
  kableExtra::column_spec(1:2, width_min = "2in")
base_table
```

For modeling, I add more fields. Here are the added fields.

```{r, echo=FALSE, warning=FALSE}
# Read in the 
base_fields <- read.csv(file.path("data_download", 
                                 "miscellaneous", 
                                 "AddedFieldsExplanation.csv"))
added_table <- base_fields %>%   
  knitr::kable() %>% 
  kable_styling() %>% 
  row_spec(0,bold=TRUE) %>%
  kableExtra::column_spec(1:2, width_min = "2in")
added_table
```

**How to run the software**

The software must be run in the order below.

First, run EPL-Downloads.R. This will create the necessary folders and download and scrape data from the web. It downloads several hundred files and takes about 30 minutes to run. Note: it's good practice to download data as little as often as a courtesy to website owners. Downloading data too frequently may result in a ban.

The next step is cleaning. Run the file EPL-Cleaning.R.

Data analysis is done by the file EPL-DataAnalysis.R.

Finally, modeling is performed by EPL-Model.R.
